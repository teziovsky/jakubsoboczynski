---
import { SEO } from "astro-seo";
import { Head } from "astro-capo";
import Footer from "@/components/footer.astro";
import Sidebar from "@/components/sidebar.astro";
import { ClientRouter } from "astro:transitions";
import { getLang } from "@/i18n/utils";
import "@/global.css";

export type Props = {
  title: string;
  titleTemplate?: string;
  description: string;
  image: string;
  isWide?: boolean;
};

const { title, titleTemplate = "%s | Jakub Soboczy≈Ñski", description, image, isWide = false } = Astro.props;

const { url } = Astro;
const lang = getLang(url);

const { pathname } = url;

const canonicalURL = new URL(pathname, Astro.site);

// Critical CSS for above-the-fold content
const criticalCSS = `
  /* Reset and base styles */
  *, ::before, ::after { box-sizing: border-box; }
  html { line-height: 1.5; -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
  body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
  
  /* Grid layout critical styles */
  .grid { display: grid; }
  .container { margin-inline: auto; padding-inline: 1rem; }
  .min-h-screen { min-height: 100vh; }
  .antialiased { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  
  /* Typography critical */
  .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
  .text-neutral-800 { color: rgb(38 38 38); }
  
  /* Layout critical */
  .grid-rows-mobile { grid-template-rows: auto 1fr auto; }
  @media (min-width: 640px) {
    .sm\\:grid-cols-sidebar { grid-template-columns: 110px 1fr; }
    .sm\\:grid-rows-desktop { grid-template-rows: 1fr auto; }
  }
  
  /* Dark mode critical */
  @media (prefers-color-scheme: dark) {
    .dark\\:bg-slate-950 { background-color: rgb(2 6 23); }
    .dark\\:text-neutral-200 { color: rgb(229 229 229); }
  }
  
  /* Background colors */
  .bg-slate-50 { background-color: rgb(248 250 252); }
  
  /* Prevent layout shift */
  img { max-width: 100%; height: auto; }
  .aspect-video { aspect-ratio: 16 / 9; }
`;

// Get the main CSS file path (you might need to adjust this based on your build output)
const mainCSSPath = "/_astro/index.css";
---

<!doctype html>
<html transition:animate="none" lang={lang}>
  <Head>
    <!-- Critical CSS inline for instant rendering -->
    <style set:html={criticalCSS}></style>

    <!-- DNS Prefetch and Preconnect for external resources -->
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />

    <!-- Preload critical resources -->
    <link rel="preload" href={mainCSSPath} as="style" />

    <!-- Load main CSS asynchronously with fallback -->
    <link rel="stylesheet" href={mainCSSPath} media="print" onload="this.media='all'; this.onload=null;" />
    <noscript>
      <link rel="stylesheet" href={mainCSSPath} />
    </noscript>

    <!-- Prefetch navigation routes for faster page transitions -->
    <link rel="prefetch" href="/projekty" as="document" />
    <link rel="prefetch" href="/uses" as="document" />
    <link rel="prefetch" href="/en/projekty" as="document" />
    <link rel="prefetch" href="/en/uses" as="document" />

    <SEO
      canonical={canonicalURL.href}
      charset="UTF-8"
      description={description}
      openGraph={{
        basic: {
          title: title,
          type: "website",
          url: canonicalURL.href,
          image: image,
        },
      }}
      title={title}
      titleTemplate={titleTemplate}
      twitter={{
        card: "summary_large_image",
        title: title,
        description: description,
        image: image,
        creator: "@teziovsky",
      }}
      extend={{
        meta: [
          {
            name: "viewport",
            content: "width=device-width, initial-scale=1",
          },
          {
            name: "generator",
            content: Astro.generator,
          },
          // Add theme color for better PWA experience
          {
            name: "theme-color",
            content: "#f8fafc",
            media: "(prefers-color-scheme: light)",
          },
          {
            name: "theme-color",
            content: "#020617",
            media: "(prefers-color-scheme: dark)",
          },
        ],
        link: [
          {
            rel: "icon",
            type: "image/svg+xml",
            media: "(prefers-color-scheme: dark)",
            href: "/favicon-dark.svg",
          },
          {
            rel: "icon",
            type: "image/svg+xml",
            media: "(prefers-color-scheme: light)",
            href: "/favicon-light.svg",
          },
          {
            rel: "sitemap",
            href: "/sitemap-index.xml",
          },
          // Add Web App Manifest for PWA
          {
            rel: "manifest",
            href: "/manifest.json",
          },
        ],
      }}
    />

    <ClientRouter />
  </Head>

  <body
    class="grid-rows-mobile sm:grid-cols-sidebar sm:grid-rows-desktop container grid min-h-screen items-start gap-12 bg-slate-50 py-4 text-neutral-800 antialiased sm:gap-6 sm:pt-24 sm:pb-8 md:gap-8 dark:bg-slate-950 dark:text-neutral-200"
    class:list={[{ "max-w-4xl": !isWide }]}
  >
    <Sidebar />
    <main class="pb-8 sm:pt-4 sm:pb-20">
      <slot />
    </main>
    <Footer />

    <!-- Global styles that don't need to be critical -->
    <style is:global>
      html {
        scroll-behavior: smooth;
      }

      @media (prefers-reduced-motion: reduce) {
        html {
          scroll-behavior: auto;
        }
      }

      /* Custom scrollbar styles - non-critical */
      ::-webkit-scrollbar {
        width: 10px;
      }

      @media (prefers-color-scheme: light) {
        ::-webkit-scrollbar-track {
          background-color: rgb(248 250 252 / var(--tw-bg-opacity));
          border-left: 1px solid rgb(226 232 240 / var(--tw-bg-opacity));
        }

        ::-webkit-scrollbar-thumb {
          background-color: rgb(226 232 240 / var(--tw-bg-opacity));
        }

        ::-webkit-scrollbar-thumb:hover {
          background-color: rgb(203 213 225 / var(--tw-bg-opacity));
        }
      }

      @media (prefers-color-scheme: dark) {
        ::-webkit-scrollbar-track {
          background-color: rgb(2 6 23 / var(--tw-bg-opacity));
          border-left: 1px solid rgb(30 41 59 / var(--tw-text-opacity));
        }

        ::-webkit-scrollbar-thumb {
          background-color: rgb(30 41 59 / var(--tw-bg-opacity));
        }

        ::-webkit-scrollbar-thumb:hover {
          background-color: rgb(51 65 85 / var(--tw-bg-opacity));
        }
      }

      .scrollbar-hidden {
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .scrollbar-hidden::-webkit-scrollbar {
        display: none;
      }

      .prose :where(ul > li > p):not(:where([class~="not-prose"] *)) {
        margin-top: 0;
        margin-bottom: 0;
      }
    </style>

    <!-- Move analytics to the end and ensure it doesn't block rendering -->
    <script type="text/partytown" async src="https://www.googletagmanager.com/gtag/js?id=G-HNBWJKKETF"></script>
    <script type="text/partytown">
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-HNBWJKKETF", {
        page_location: window.location.href,
        page_path: window.location.pathname,
        page_title: document.title,
        send_page_view: true,
      });
    </script>
  </body>
</html>
